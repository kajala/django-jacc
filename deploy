source venv/bin/activate
python manage.py test
if [ "$?" != "0" ]; then
    echo "Django manage.py test reported problems, terminating release"
    exit 1
fi
echo "Django manage.py test ok, proceeding..."

source venv/bin/activate
prospector
if [ "$?" != "0" ]; then
    echo "Prospector reported problems, terminating release"
    exit 1
fi
echo "Prospector cleared build, proceeding..."

DIR=`pwd`
PROJECT=`basename $DIR`
REL=`parse-setup-version.py`
echo "Making release $REL of $PROJECT"

rm -rf dist
python3 setup.py sdist

# clean venv/ directory from the dist
# TODO: cleaner way to do this (using setup.py/MANIFEST.in)
cd dist
FILE="$PROJECT-$REL"
echo $FILE
cd dist
tar xvf "$FILE.tar.gz"
rm -rf "$FILE/venv"
rm "$FILE.tar.gz"
find . -name "__pycache__" -type d -exec rm -r "{}" \;
tar zcvf "$FILE.tar.gz" $FILE
rm -rf $FILE
cd ..

twine upload dist/$FILE.tar.gz

